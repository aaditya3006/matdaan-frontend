<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Matdaan | Secure Voter Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>
        :root {
            /* Dark Mode Palette (Default) */
            --bg-body: #0f172a;
            --bg-overlay: rgba(15, 23, 42, 0.7); /* Slightly more transparent for glass effect */
            --card-gradient: linear-gradient(145deg, rgba(30, 41, 59, 0.6), rgba(15, 23, 42, 0.8));
            --text-color: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #6366f1; /* Electric Indigo */
            --accent-hover: #4f46e5;
            --input-bg: rgba(30, 41, 59, 0.5);
            --card-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
            --border-color: rgba(255, 255, 255, 0.1);
        }

        .light-mode {
            /* Light Mode Palette */
            --bg-body: #f1f5f9;
            --bg-overlay: rgba(241, 245, 249, 0.6);
            --card-gradient: linear-gradient(145deg, rgba(255, 255, 255, 0.7), rgba(248, 250, 252, 0.8));
            --text-color: #1e293b;
            --text-muted: #64748b;
            --accent: #4f46e5;
            --accent-hover: #4338ca;
            --input-bg: rgba(255, 255, 255, 0.5);
            --card-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            --border-color: rgba(255, 255, 255, 0.4);
        }

        * { box-sizing: border-box; font-family: 'Inter', 'Segoe UI', system-ui, sans-serif; transition: all 0.3s ease; }
        body { margin: 0; background: var(--bg-body); color: var(--text-color); overflow: hidden; }

        #videoBG { position: fixed; inset: 0; z-index: -1; background: var(--bg-body); }
        #videoBG video { width: 100vw; height: 100vh; object-fit: cover; opacity: 0.3; }

        .theme-utility { position: fixed; right: 25px; top: 50%; transform: translateY(-50%); z-index: 100; }
        .theme-btn { 
            background: var(--card-gradient); border: 1px solid var(--border-color); 
            width: 45px; height: 45px; border-radius: 12px; cursor: pointer; color: var(--accent); 
            display: flex; align-items: center; justify-content: center; backdrop-filter: blur(10px);
            box-shadow: var(--card-shadow);
        }
        .theme-btn:hover { transform: scale(1.1); color: var(--text-color); background: var(--accent); }

        #loginBox { position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: var(--bg-overlay); }
        
        /* â”€â”€ GLASS EFFECT CARD â”€â”€ */
        .login-card { 
            width: 400px; padding: 40px; border-radius: 24px; 
            background: var(--card-gradient); 
            text-align: center; 
            box-shadow: var(--card-shadow); 
            border: 1px solid var(--border-color); 
            position: relative; z-index: 10;
            backdrop-filter: blur(16px); /* The main glass effect */
            -webkit-backdrop-filter: blur(16px); /* Safari support */
        }

        .admin-btn {
            position: absolute; top: 20px; right: 20px; display: flex; align-items: center;
            gap: 6px; padding: 8px 14px; border-radius: 10px; background: rgba(99, 102, 241, 0.1);
            color: var(--accent); font-size: 12px; cursor: pointer; border: 1px solid var(--border-color); 
            text-decoration: none; font-weight: 600;
        }
        .admin-btn:hover { background: var(--accent); color: white; }

        .icon-box { 
            width: 70px; height: 70px; margin: 0 auto 20px; border-radius: 20px; 
            background: linear-gradient(135deg, var(--accent), #818cf8); 
            display: flex; justify-content: center; align-items: center; overflow: hidden;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.3);
        }
        .icon-box video { width: 120%; }

        h1 { color: var(--text-color); margin: 0; font-size: 24px; font-weight: 700; }
        .tricolor-wave { 
            font-size: 28px; font-weight: 800; letter-spacing: 2px;
            background: linear-gradient(to right, #FF9933, #ffffff, #138808); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 25px; 
        }

        .election-selector {
            background: var(--input-bg); color: var(--text-color);
            border: 1px solid var(--border-color); padding: 12px;
            width: 100%; border-radius: 12px; margin-bottom: 15px; outline: none; cursor: pointer;
        }

        .input-box { 
            display: flex; align-items: center; background: var(--input-bg); 
            padding: 14px; border-radius: 12px; margin: 15px 0; border: 1px solid var(--border-color);
        }
        .input-box:focus-within { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); }
        .input-box input { flex: 1; background: none; border: none; color: var(--text-color); outline: none; font-size: 16px; text-align: center; }
        
        #mainBtn { 
            width: 100%; padding: 16px; border: none; border-radius: 14px; 
            background: var(--accent); font-weight: 700; cursor: pointer; 
            color: white; font-size: 16px; margin-top: 10px;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        #mainBtn:hover { background: var(--accent-hover); transform: translateY(-2px); }
        #mainBtn:active { transform: translateY(0); }

        #loader { display: none; margin: 15px 0; color: var(--accent); font-size: 14px; font-weight: 600; }

        /* Ballot Overlay */
        #ballotView {
            display: none; position: fixed; inset: 0; background: var(--bg-overlay);
            z-index: 1000; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .ballot-card {
            width: 90%; max-width: 480px; background: var(--card-gradient);
            padding: 35px; border-radius: 28px; border: 1px solid var(--border-color); text-align: center;
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(16px);
        }
        .candidate-row {
            display: flex; justify-content: space-between; align-items: center;
            background: var(--input-bg); padding: 18px; border-radius: 15px; margin-bottom: 12px;
            border: 1px solid var(--border-color);
        }
        .vote-btn {
            background: #ef4444; color: white; border: none; padding: 10px 22px;
            border-radius: 10px; cursor: pointer; font-weight: 700;
        }
        .vote-btn:hover { background: #dc2626; transform: scale(1.05); }
    </style>
</head>

<body>

<div id="videoBG"><video autoplay muted loop playsinline><source src="intro2.mp4" type="video/mp4"></video></div>

<div class="theme-utility">
    <button class="theme-btn" onclick="toggleTheme()"><i class="fa-solid fa-moon" id="themeIcon"></i></button>
</div>

<div id="loginBox">
    <div class="login-card">
        <a href="admin.html" class="admin-btn"><i class="fa-solid fa-user-shield"></i> <span>Admin</span></a>
        <div class="icon-box"><video autoplay muted loop><source src="fingerprint.mp4" type="video/mp4"></video></div>

        <h1>Blockchain Voting</h1>
        <div class="tricolor-wave">à¤®à¤¤à¤¦à¤¾à¤¨</div>

        <select id="electionSelect" class="election-selector" onchange="updateAuthUI()">
            <option value="">-- Select Active Election --</option>
        </select>

        <div id="inputContainer">
            <div class="input-box" id="authBox">
                <input type="text" id="authID" placeholder="Enter ID">
            </div>
            <div class="input-box" id="mobileBox" style="display:none;">
                <input type="number" id="mobile" placeholder="Mobile Number">
            </div>
            <div class="input-box" id="otpBox" style="display:none;">
                <input type="text" id="otp" placeholder="6-Digit OTP">
            </div>
        </div>

        <div id="loader">ðŸ”„ Initializing Ledger...</div>
        <button id="mainBtn" onclick="handleLoginFlow()">Verify Identity</button>
    </div>
</div>

<div id="ballotView">
    <div class="ballot-card">
        <h2 style="color:var(--accent); margin-bottom: 5px;">Cast Your Secret Vote</h2>
        <p id="ballotElectionTitle" style="color:var(--text-muted); margin-bottom: 25px;"></p>
        <div id="candidateList"></div>
        <button onclick="location.reload()" style="background:none; border:none; color:var(--text-muted); cursor:pointer; margin-top:20px; font-weight: 600;">Cancel Transaction</button>
    </div>
</div>

<script>
let currentStep = 1;
let selectedElection = null;

function loadElections() {
    const elecs = JSON.parse(localStorage.getItem('m_elecs')) || [];
    const select = document.getElementById('electionSelect');
    select.innerHTML = '<option value="">-- Select Active Election --</option>';
    
    elecs.forEach(e => {
        if(e.status === 'Live') {
            let opt = document.createElement('option');
            opt.value = e.id;
            opt.innerText = e.title;
            select.appendChild(opt);
        }
    });
}

function updateAuthUI() {
    const elecs = JSON.parse(localStorage.getItem('m_elecs')) || [];
    const selectId = document.getElementById('electionSelect').value;
    selectedElection = elecs.find(e => e.id == selectId);
    
    const inputField = document.getElementById('authID');
    if(selectedElection) {
        inputField.placeholder = `Enter ${selectedElection.auth}`;
    } else {
        inputField.placeholder = "Enter ID";
    }
}

function handleLoginFlow() {
    if (!selectedElection) return alert("Please select an election first");

    if (currentStep === 1) {
        const idVal = document.getElementById("authID").value.trim().toUpperCase();
        const globalVoters = JSON.parse(localStorage.getItem('m_voters')) || [];
        const inGlobal = globalVoters.some(v => v.id.toUpperCase() === idVal);
        const inElectionList = selectedElection.authorized && selectedElection.authorized.includes(idVal);

        if (!inGlobal && !inElectionList) {
            return alert(`Unauthorized: ${idVal} is not registered in the system.`);
        }

        showLoading("Accessing Blockchain...", () => {
            document.getElementById("authBox").style.display = "none";
            document.getElementById("mobileBox").style.display = "flex";
            currentStep = 2;
        });
    }

    else if (currentStep === 2) {
        const mobileNum = document.getElementById("mobile").value;
        if (mobileNum.length !== 10) return alert("Invalid Mobile Number");
        
        showLoading("Generating OTP...", () => {
            document.getElementById("mobileBox").style.display = "none";
            document.getElementById("otpBox").style.display = "flex";
            currentStep = 3;
        });
    }

    else if (currentStep === 3) {
        const otpVal = document.getElementById("otp").value;
        if (otpVal.length !== 6) return alert("Invalid OTP (Enter 6 digits)");

        showLoading("Finalizing Secure Session...", () => {
            localStorage.setItem("isLoggedIn", "true");
            localStorage.setItem("voterID", document.getElementById("authID").value);
            
            setTimeout(() => {
                window.location.href = "dashboard.html";
            }, 800);
        });
    }
}

function showLoading(msg, cb) {
    const loader = document.getElementById("loader");
    const mainBtn = document.getElementById("mainBtn");
    loader.innerText = msg;
    loader.style.display = "block";
    mainBtn.disabled = true;
    setTimeout(() => {
        loader.style.display = "none";
        mainBtn.disabled = false;
        cb();
    }, 1200);
}

function toggleTheme() { 
    document.body.classList.toggle("light-mode"); 
    const icon = document.getElementById('themeIcon');
    if(document.body.classList.contains('light-mode')) {
        icon.classList.replace('fa-moon', 'fa-sun');
    } else {
        icon.classList.replace('fa-sun', 'fa-moon');
    }
}

window.onload = loadElections;
</script>
</body>
</html>